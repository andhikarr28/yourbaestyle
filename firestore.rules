rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // -------------------------------------------------------------------------
    // User Profiles
    // User documents are no longer created, but the path is used for subcollections.
    // Disallow direct access to user documents.
    // -------------------------------------------------------------------------
    match /users/{userId} {
      allow read, write: if false;
    }
    
    // -------------------------------------------------------------------------
    // Global Knowledge Base
    // Read-only for any authenticated (anonymous) user.
    // Writable for any authenticated (anonymous) user, as all users are considered admin.
    // -------------------------------------------------------------------------
    match /knowledge/{knowledgeId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }
    
    // -------------------------------------------------------------------------
    // User-Owned Chat Logs
    // -------------------------------------------------------------------------
    match /users/{userId}/chatLogs/{chatLogId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if false; // Chat logs should be immutable.
      allow delete: if isOwner(userId); // Allow owner to delete their logs.
    }
  }
}
